#!/usr/bin/env ruby

require 'rubygems'
require 'commander/import'
require 'experiment'
require 'rugged'

program :name, 'experiment'
program :version, Experiment::VERSION
program :description, 'A tool for running concurrent multi-configuration experiments'

command :run do |c|
	c.syntax = 'experiment run [options]'
	c.summary = 'Run the experiments outlined in experiment.json'
	#c.description = ''
	#c.example 'description', 'command example'
	#c.option '--some-switch', 'Some switch that does something'
	c.action do |args, options|
		begin
			config = Experiment::read_config Dir.pwd
		rescue Exception => er
			raise ArgumentError.new er.message
		end

		config["repository"]  = config["repository"].gsub("~", Dir.home)
		repo = Rugged::Repository.new(config["repository"])

		versions = {}
		config["versions"].each do |vname, version|
			Dir.mkdir vname
			versions[vname] = Experiment::Application.new(:wd => Dir.pwd + "/" + vname,
								      :config => config,
								      :version => version,
								      :repo => repo)
		end

		running = 0
		for n in 0..config["iterations"] do
			versions.each do |vname, a|
				while running >= config["parallelism"]
					sleep 1
				end

				a.run(n)
				running += 1
			end
		end

	end
end
default_command :run
